name: Prod Deploy

on:
  # Only manuel deployment for now
  workflow_dispatch:

# See https://github.com/marketplace/actions/deploy-to-clever-cloud
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    # Get source
    - name: Local shallow copy
      run: git fetch --prune --unshallow

    # Deploy to clever cloud
    - name: Deploy to Staging
      uses: PieterjanMontens/actions-clever-cloud@master
      with:
        appID: ${{ secrets.APP_PROD }}
      env:
        CLEVER_TOKEN: ${{ secrets.CLEVER_TOKEN }}
        CLEVER_SECRET: ${{ secrets.CLEVER_SECRET }}

    # Notify Slack on failure or success
    # https://github.com/marketplace/actions/slack-notify-deployment
    - name: Notify slack success
      if: success()
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      uses: Discontract/github-action-slack-notify-deployment@v1
      with:
        message_id: ${{ steps.slack.outputs.message_id }}
        channel: c4-business
        status: SUCCESS
        color: good
    - name: Notify slack fail
      if: failure()
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      uses: Discontract/github-action-slack-notify-deployment@v1
      with:
        channel: c4-business
        status: FAILED
        color: danger
