{% load static %}
<style>
    .fr-input-wrap {
        display: flex;
        align-items: center;
        position: relative;
    }
    .fr-input-wrap input {
        flex-grow: 1;
    }
    .fr-input-wrap button {
        margin-left: 8px;
    }
    .fr-checkbox-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        max-height: 200px;
        overflow-y: auto;
        padding: 8px;
        display: none;
    }
    .fr-checkbox-list.show {
        display: block;
    }
</style>
<div x-data="multiselect()" class="fr-checkbox-group" {{ widget.attrs }}>
    <div class="fr-input-wrap">
        <input type="text"
               class="fr-input"
               x-model="selectedLabels"
               readonly
               placeholder="SÃ©lectionner des options">
        <button type="button"
                class="fr-btn fr-btn--icon-right fr-m-0"
                @click="toggle"
                :class="open ? ' fr-icon-arrow-up-s-line' : 'fr-icon-arrow-down-s-line'"></button>
    </div>
    <div x-show="open"
         x-ref="dropdown"
         class="fr-checkbox-list"
         :class="{ show: open }">
        {% for group, options, index in widget.optgroups %}
            {% if group %}<div class="fr-checkbox-group-title">{{ group }}</div>{% endif %}
            {% for option in options %}
                <div class="fr-checkbox fr-py-1w">
                    <input type="checkbox"
                           id="{{ option.attrs.id }}"
                           name="{{ widget.name }}"
                           value="{{ option.value }}"
                           x-value="{{ option.label }}"
                           {% if option.selected %}checked{% endif %}
                           {% include "django/forms/widgets/attrs.html" %}
                           @click="updateSelection($event)">
                    <label for="{{ option.attrs.id }}">{{ option.label }}</label>
                </div>
            {% endfor %}
        {% endfor %}
    </div>
</div>
<script>
function multiselect() {
    return {
        open: false,
        selected: [],
        selectedLabels: '',
        toggle() {
            this.open = !this.open;
        },
        updateSelection(event) {
            const label = event.target.getAttribute('x-value');
            if (event.target.checked) {
                this.selected.push(label);
            } else {
                this.selected = this.selected.filter(item => item !== label);
            }
            this.updateInput();
        },
        updateInput() {
            this.selectedLabels = this.selected.map(label => {
                if (label.length > 10) {
                    return label.substring(0, 10) + '...';
                }
                return label;
            }).join(', ');
        }
    };
}
</script>
