{% extends "layouts/base.html" %}
{% load static bootstrap4 show_first_form_error_message %}

{% block title %}Recherche{{ block.super }}{% endblock %}

{% block breadcrumbs %}
<section>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="c-breadcrumb c-breadcrumb--marche" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'pages:home' %}">Accueil</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Recherche</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<section class="s-siae-01">
    <div class="container">
        <div id="dir_form" class="dir_form">
            <form method="GET" action="{% url 'siae:search_results' %}" id="search-form" aria-label="Rechercher des structures de l’insertion et du handicap" role="search">
                {% if form.errors %}
                    <div class="alert alert-danger" role="alert">{{ form.errors|show_first_form_error_message }}</div>
                {% endif %}
                <div class="row">
                    <div class="col-12 col-lg-8">
                        <div class="row first-row">
                            <div class="col-12 col-md-6 mt-lg-3 pr-md-0">
                                {% bootstrap_field form.sectors %}
                            </div>
                            {% bootstrap_field form.perimeter %}
                            <div class="col-12 col-md-6 mt-lg-3">
                                <div id="dir_form_perimeter_name" class="form-group">
                                    <label for="perimeter_name">{{ form.perimeter_name.label }}</label>
                                    <div class="field-holder">
                                        <div>
                                            {# {{ form.perimeter_name }} #}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 col-md-4 mt-lg-2 pr-md-0">
                                {% bootstrap_field form.kind %}
                            </div>
                            <div class="col-12 col-md-4 mt-lg-2 pr-md-0">
                                {% bootstrap_field form.presta_type %}
                            </div>
                            <div class="col-12 col-md-4 mt-lg-2">
                                {% bootstrap_field form.networks %}
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-2 mt-3 mt-3 mt-md-0 mt-lg-3 pr-sm-0 pr-lg-2">
                        <span class="mb-2 d-none d-md-inline-block">&nbsp;</span>
                        <button id="filter-submit" class="btn btn-primary btn-block btn-ico" type="submit">
                            <span>Rechercher</span>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none">
                                <path d="M12.523 10.963l3.213 3.211-1.062 1.062-3.211-3.213A6.72 6.72 0 017.25 13.5 6.752 6.752 0 01.5 6.75 6.752 6.752 0 017.25 0 6.752 6.752 0 0114 6.75a6.72 6.72 0 01-1.477 4.213zm-1.504-.557A5.233 5.233 0 0012.5 6.75c0-2.901-2.35-5.25-5.25-5.25A5.248 5.248 0 002 6.75C2 9.65 4.349 12 7.25 12a5.233 5.233 0 003.656-1.481l.113-.113z" fill="currentColor" />
                            </svg>
                        </button>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-2 mt-3  mt-3 mt-md-0 mt-lg-3 pl-lg-2">
                        <span class="mb-2 d-none d-md-inline-block">&nbsp;</span>
                        <a href="{% url 'siae:search_results' %}" class="btn btn-outline-primary btn-block reset btn-ico">
                            <span>Réinitialiser</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M5.463 4.43301C7.27756 2.86067 9.59899 1.99666 12 2.00001C17.523 2.00001 22 6.47701 22 12C22 14.136 21.33 16.116 20.19 17.74L17 12H20C20.0001 10.4316 19.5392 8.89781 18.6747 7.58927C17.8101 6.28072 16.5799 5.25517 15.1372 4.64013C13.6944 4.0251 12.1027 3.84771 10.56 4.13003C9.0172 4.41234 7.59145 5.14191 6.46 6.22801L5.463 4.43301ZM18.537 19.567C16.7224 21.1393 14.401 22.0034 12 22C6.477 22 2 17.523 2 12C2 9.86401 2.67 7.88401 3.81 6.26001L7 12H4C3.99987 13.5684 4.46075 15.1022 5.32534 16.4108C6.18992 17.7193 7.42007 18.7449 8.86282 19.3599C10.3056 19.9749 11.8973 20.1523 13.44 19.87C14.9828 19.5877 16.4085 18.8581 17.54 17.772L18.537 19.567Z" fill="currentColor" />
                            </svg>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>

<section class="s-siae-02">
    <div class="container">
        <div id="dir_list">
            <div class="row">
                <div class="col-12">
                    <h1 class="meta h2 mb-3 mb-md-5 font-weight-bold text-center text-md-left">
                        {% with paginator.count as siae_count %}
                            {{ siae_count }} structure{% if siae_count > 1 %}s{% endif %} correspond{% if siae_count > 1 %}ent{% endif %} à vos critères
                        {% endwith %}
                    </h1>
                </div>
            </div>
            <div class="row dir_list-row">
                <div class="col-12 col-md-8">
                {% if siaes %}
                    {% for siae in siaes %}
                        {% include "siaes/_card_search_result.html" with siae=siae %}
                    {% endfor %}
    
                    {% include "includes/_pagination.html" %}

                    <br />

                    <div class="row justify-content-center">
                        <div class="col-sm-6">
                            {% if user.is_authenticated %}
                                <div class="btn-group btn-block">
                                    <a href="{% url 'siae:search_results_download' %}?{{ current_search_query }}&format=xls" id="siae-export-xls" class="btn btn-block btn-outline-primary btn-ico">
                                        <span>Télécharger la liste (.xls)</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path fill="none" d="M0 0h24v24H0z"/><path fill="currentColor" d="M13 10h5l-6 6-6-6h5V3h2v7zm-9 9h16v-7h2v8a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-8h2v7z"/></svg>
                                    </a>
                                    <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="sr-only">Plus d'options de téléchargement</span>
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a href="{% url 'siae:search_results_download' %}?{{ current_search_query }}&format=csv" id="siae-export-csv" class="dropdown-item">
                                            Télécharger la liste (.csv)
                                        </a>
                                    </div>
                                </div>
                            {% else %}
                                <a href="#" id="siae-export-anon" class="btn btn-block btn-outline-primary" data-toggle="modal" data-target="#login_or_signup_modal" data-next-params="{% url 'siae:search_results' %}?{{ current_search_query_escaped }}">
                                    Télécharger la liste
                                </a>
                            {% endif %}
                        </div>
                    </div>
    
                {% else %}
                    <div class="no-results">
                        <p class="lead">
                            Malheureusement, nous n'avons pas encore de prestataires correspondant à votre recherche sur La place de marché de l'inclusion.
                        </p>
                        <p>
                            <strong>Faites nous part de votre besoin et nous vous recontacterons rapidement</strong>
                        </p>
                        <div class="mt-3 mt-lg-5">
                            <a href="https://itou.typeform.com/to/nxG0HlYx" class="btn btn-primary btn-ico">
                                <span>Déposez votre demande</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16">
                                    <path fill="currentColor" fill-rule="nonzero" stroke="currentColor" d="M1.964 8.95h11.03L9.51 12.737a.451.451 0 00.037.646.474.474 0 00.66-.037L14.386 8.8l.035-.043.033-.05.013-.05V8.539c0-.012.033-.02.033-.044v-.151l-.014-.05-.019-.03-.034-.045-4.193-4.566a.474.474 0 00-.66-.037.452.452 0 00-.036.646l3.45 3.777H1.963a.46.46 0 00-.464.455.46.46 0 00.464.455z"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                {% endif %}
                </div>
                <div class="col-12 col-md-4 siae-info mt-6 mt-sm-0">
                    <div class="siae-info-sticky">
                        <div class="map-holder mb-4">
                            <div id="map-siae-list" class="map-canvas"></div>
                        </div>
                        <div class="si-separator"></div>
                        <div class="si-ideas">
                            <h3 class="h2 my-3">Idées reçues</h3>
                            <p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z" fill="currentColor" /></svg>
                                </span>
                                <span class="ml-2">
                                    La structure est trop petite pour répondre à mon besoin…
                                    <b>Mais elle est sûrement ouverte à la co-traitance.</b>
                                </span>
                            </p>
                            <p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z" fill="currentColor" /></svg>
                                </span>
                                <span class="ml-2">
                                    Son chiffre d’affaire est trop bas et je ne veux pas être
                                    son seul client… <b>Mais Vous pouvez commencer par lui confier
                                    un marché de plus faible périmètre, sans prendre de risque,
                                    puis faire grandir ce partenariat si vous en êtes satisfait.</b>
                                </span>
                            </p>
                            <p>
                                <span>
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 15.172l9.192-9.193 1.415 1.414L10 18l-6.364-6.364 1.414-1.414z" fill="currentColor" /></svg>
                                </span>
                                <span class="ml-2">
                                    L'offre ne correspond pas exactement à ce que je cherche…
                                    <b>Heureusement les entreprises sociales inclusives sont très
                                    innovantes et s'adaptent à vos besoins.</b>
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block modals %}
    {% include "includes/_user_type_modal.html" with search_results_count=paginator.count %}
    {% include "auth/_login_or_signup_modal.html" %}
    {% include "siaes/_favorite_modal.html" %}
    {% include "siaes/_favorite_item_remove_modal.html" %}
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
    // Set listings markers on load
    const siaeList = {{ siaes_json|safe }};

    // init map
    var map = L.map('map-siae-list').setView([47.08333, 2.4], 5);

    // map tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19,
        zoomControl: false,
    }).addTo(map);

    // map zoom controls in the bottom right
    map.zoomControl.remove();
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // create custom marker (because of static url issues)
    var customLeafletIcon = L.icon({
        'iconUrl': "{% static 'vendor/leaflet-1.7.1/images/marker-icon.png' %}",
        'shadowUrl': "{% static 'vendor/leaflet-1.7.1/images/marker-shadow.png' %}",
        iconSize: [25,41],
        iconAnchor: [12,41],
        popupAnchor:[1,-34],
        tooltipAnchor:[16,-28],
        shadowSize:[41,41],
    });

    // add markers from geojson data (with popup on click)
    var geojson = L.geoJSON(siaeList, {
        pointToLayer: function(geoJsonPoint, latlng) {
            return L.marker(latlng, {icon: customLeafletIcon});
        },
        onEachFeature: function (feature, layer) {
            var featureDisplayName = feature.properties.brand ? feature.properties.brand : feature.properties.name;
            layer.bindPopup(`<a href="/prestataires/${feature.properties.slug}/"><p class="h6">${featureDisplayName}</p></a>`);
        }
    }).addTo(map);
    map.fitBounds(geojson.getBounds());
});
</script>
{% if user.is_authenticated %}
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
    $('#favorite_modal').on('show.bs.modal', function (event) {
        // Button that triggered the modal
        var button = $(event.relatedTarget);

        // Extract info from data-* attributes
        var siaeId = button.data('siae-id');
        var siaeSlug = button.data('siae-slug');
        var siaeNameDisplay = button.data('siae-name-display');

        // Update the modal's content
        // - siae name display
        // - check favorite lists that already contain the siae
        // - edit the form action url
        var modal = document.querySelector('#favorite_modal');
        var modalForms = modal.querySelectorAll('form');
        if (modal.querySelector('#siae-name-display')) {
            modal.querySelector('#siae-name-display').textContent = siaeNameDisplay;
        }
        modalForms.forEach(form => {
            var formActionUrl = form.getAttribute('action');
            form.setAttribute('action', formActionUrl.replace('siae-slug-to-replace', siaeSlug));
        });
    });
});
</script>
<script type="text/javascript" src="{% static 'js/favorite_item_remove.js' %}"></script>
{% endif %}
{% endblock %}
