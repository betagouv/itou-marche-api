{% extends "layouts/base.html" %}
{% load static get_verbose_name %}
{% load theme_inclusion %}

{% block title %}Tableau de bord{{ block.super }}{% endblock %}

{% block breadcrumbs %}
<section>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="c-breadcrumb c-breadcrumb--marche" aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'pages:home' %}">Accueil</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'dashboard:home' %}">Mon espace</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Tableau de bord</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<section class="py-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 id="profil" class="mb-3 mb-lg-5">
                    <strong>Mon profil</strong>
                </h1>

                <!-- Profile -->
                <div class="s-cards-grid-01__row row mb-3 mb-md-5">
                    <div class="s-cards-grid-01__col col">
                        <div class="card c-card c-card--marche h-100 w-100">
                            <div class="card-body">
                                <p class="h3 lh-base">
                                    {{ user.full_name }}
                                    <span class="fs-sm badge-pill badge-marche">{{ user.get_kind_display }}</span>
                                </p>
                                <p title="{% get_verbose_name user 'email' %}">
                                    <span class="prof_icon"><img src="{% static 'img/profile-ico-@.svg' %}" /></span>
                                    {{ user.email }}
                                </p>
                                <p title="{% get_verbose_name user 'phone' %}">
                                    <span class="prof_icon"><img src="{% static 'img/profile-ico-phone.svg' %}" /></span>
                                    {% if user.phone %}{{ user.phone }}{% endif %}
                                </p>
                                {% if user.company_name %}
                                    <p title="{% get_verbose_name user 'company_name' %}">
                                        <span class="prof_icon"><img src="{% static 'img/prof_nature.svg' %}" /></span>
                                        {{ user.company_name }}
                                        {% if user.position %}({{ user.position }}){% endif %}
                                    </p>
                                {% endif %}
                            </div>
                            <div class="card-footer">
                                <div class="row justify-content-end">
                                    <div class="col-6 col-md-auto pl-2">
                                        <a href="{% url 'dashboard:profile_edit' %}" class="btn btn-outline-primary btn-block btn-ico">
                                            <span>Modifier</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path fill="none" d="M0 0h24v24H0z"/><path fill="currentColor" d="M12.9 6.858l4.242 4.243L7.242 21H3v-4.243l9.9-9.9zm1.414-1.414l2.121-2.122a1 1 0 0 1 1.414 0l2.829 2.829a1 1 0 0 1 0 1.414l-2.122 2.121-4.242-4.242z"/></svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="mb-3 mb-lg-5">
                <div id="favoris" class="row justify-content-end mb-3 mb-lg-5">
                    <div class="col-12 col-lg">
                        <h2 id="structures" class="h1 mb-0">
                            <strong>Liste d'achat favoris</strong>
                        </h2>
                    </div>
                    <div class="col-12 col-md-auto">
                        <a href="{% url 'dashboard:profile_favorite_list' %}" class="btn btn-outline-primary btn-block btn-ico">
                            <span>Voir</span>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path fill="none" d="M0 0h24v24H0z"/><path fill="currentColor" d="M1.181 12C2.121 6.88 6.608 3 12 3c5.392 0 9.878 3.88 10.819 9-.94 5.12-5.427 9-10.819 9-5.392 0-9.878-3.88-10.819-9zM12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-2a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
                        </a>
                    </div>
                </div>

                <!-- Mes structures -->
                {% if user.kind == user.KIND_SIAE or user.kind == user.KIND_ADMIN %}
                    <hr class="mb-3 mb-lg-5">
                    <div id="structures" class="row justify-content-end mb-3 mb-lg-5">
                        <div class="col-12 col-lg">
                            <h2 id="structures" class="h1 mb-0">
                                <strong>{% if user.siaes.count > 1 %}Mes structures{% else %}Ma structure{% endif %}</strong>
                            </h2>
                        </div>
                        <div class="col-12 col-md-auto">
                            <a href="{% url 'dashboard:siae_search_by_siret' %}" class="btn btn-primary btn-block btn-ico">
                                <span>Ajouter une structure</span>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path fill="none" d="M0 0h24v24H0z"/><path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
                            </a>
                        </div>
                    </div>
                    <div class="s-cards-grid-01__row row row-cols-1 row-cols-md-2">
                        {% for siaeuser in user.siaeuser_set.all %}
                        <div class="s-cards-grid-01__col col d-sm-flex">
                            <div class="card c-card c-card--mini mb-3 w-100">
                                <div class="card-body">
                                    <h3>{{ siaeuser.siae.name }}</h3>
                                    <p title="{% get_verbose_name siaeuser.siae 'brand' %}" class="mb-2">
                                        <strong>{% get_verbose_name siaeuser.siae 'brand' %} :</strong>
                                        {{ siaeuser.siae.brand|default:'' }}
                                    </p>
                                    <p title="{% get_verbose_name siaeuser.siae 'siret' %}" class="mb-2">
                                        <strong>{% get_verbose_name siaeuser.siae 'siret' %} :</strong>
                                        {{ siaeuser.siae.siret_display }}
                                    </p>
                                    <p title="{% get_verbose_name siaeuser.siae 'kind' %}" class="mb-2">
                                        <strong>{% get_verbose_name siaeuser.siae 'kind' %} :</strong>
                                        {{ siaeuser.siae.get_kind_display }}
                                    </p>
                                    <p title="{% get_verbose_name siaeuser.siae 'nature' %}" class="mb-2">
                                        <strong>{% get_verbose_name siaeuser.siae 'nature' %} :</strong>
                                        {{ siaeuser.siae.get_nature_display }}
                                    </p>
                                    {% if siaeuser.siae.is_missing_content %}
                                    <div class="alert alert-warning mt-3 mb-0" role="alert">
                                        <span class="prof_icon"><img src="{% static 'img/prof_info_circle.svg' %}" /></span>
                                        Votre fiche n'est pas compl√®te.
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer">
                                    <div class="row justify-content-end">
                                        <div class="col-6 col-md-auto pr-2">
                                            <a href="{% url 'dashboard:siae_edit' siaeuser.siae.slug %}" class="btn btn-outline-primary btn-sm btn-block btn-ico">
                                                <span>Modifier</span>
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path fill="none" d="M0 0h24v24H0z"/><path fill="currentColor" d="M12.9 6.858l4.242 4.243L7.242 21H3v-4.243l9.9-9.9zm1.414-1.414l2.121-2.122a1 1 0 0 1 1.414 0l2.829 2.829a1 1 0 0 1 0 1.414l-2.122 2.121-4.242-4.242z"/></svg>
                                            </a>
                                        </div>
                                        <div class="col-6 col-md-auto pl-2">
                                            <a href="{% url 'siae:detail' siaeuser.siae.slug %}" target="_blank" class="btn btn-outline-primary btn-sm btn-block btn-ico">
                                                <span>Voir</span>
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path fill="none" d="M0 0h24v24H0z"/><path fill="currentColor" d="M1.181 12C2.121 6.88 6.608 3 12 3c5.392 0 9.878 3.88 10.819 9-.94 5.12-5.427 9-10.819 9-5.392 0-9.878-3.88-10.819-9zM12 17a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-2a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}

                {% if user.api_key %}
                    <hr class="mb-3 mb-lg-5">
                    <div id="api" class="row justify-content-end mb-3 mb-lg-5">
                        <div class="col-12 col-lg">
                            <h2 id="api" class="h1 mb-0">
                                <strong>Acc√®s API</strong>
                            </h2>
                        </div>
                        <div class="col-12 col-md-auto">
                            <a href="{% url 'api:home' %}" class="btn btn-outline-primary btn-block btn-ico">
                                <span>üìö Tous les d√©tails sur l'API</span>
                            </a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 col-md-6">
                            <div class="form-group">
                                <label>Votre token</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" id="user-api-key" class="form-control" value="{{ user.api_key }}" readonly />
                                    <div class="input-group-append">
                                        <button id="user-api-key-copy-button" class="btn btn-primary" type="button" id="button-addon2">Copier</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

{% if user.kind == user.KIND_SIAE %}
    <section class="s-banniere-01 s-banniere-01--marche">
        <div class="s-banniere-01__container container">
            <div class="s-banniere-01__row row">
                <div class="s-banniere-01__col col-12">
                    <div class="d-flex flex-column flex-md-row">
                        <div class="text-center text-md-left">
                            <a href="https://aides-territoires.beta.gouv.fr/" target="_blank" rel="noopener">
                                <img src="{% static_theme_images 'logo-aides-territoires.svg' %}" alt="Aides-territoires | Aides publiques pour les collectivit√©s" height="120" />
                            </a>
                        </div>
                        <div class="w-100 mt-3 pl-0 pl-md-3">
                            <p class="h3 mb-2">Trouver des aides financi√®res sur votre territoire pour faciliter votre d√©veloppement.</p>
                            <p>Venez d√©couvrir plus de 2900 aides r√©pertori√©es sur tout le territoire.</p>
                            <p class="mb-0 text-right">
                                <a href="https://aides-territoires.beta.gouv.fr/" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary btn-ico" title="Aides-territoires | Aides publiques pour les collectivit√©s">
                                    <span>Aides-territoires</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" aria-hidden="true">
                                        <path fill="currentColor" d="M8.66517015,2.82577407 C8.34562066,3.18534827 8.34130426,3.73389577 8.67429909,4.0990571 L11.359,7.039 L1.46428571,7.03948778 C0.93400271,7.03948778 0.5,7.46464861 0.5,7.99431466 L0.506519822,8.10609811 C0.562491613,8.58254879 0.971880067,8.94914154 1.46428571,8.94914154 L11.354,8.949 L8.64311662,11.8995038 C8.28105469,12.2965343 8.31618249,12.9073498 8.7191121,13.2599671 C9.11604213,13.6073339 9.72177649,13.5739032 10.0771295,13.184224 L14.2544508,8.63732099 L14.3103844,8.56958432 L14.3728703,8.47818478 L14.4352531,8.3399089 L14.4491817,8.28987794 L14.462,8.193 L14.4705425,8.17556014 C14.4890266,8.12237865 14.5,8.06201568 14.5,7.99431466 L14.5,7.84422179 L14.4816817,7.71012206 L14.4677531,7.6600911 L14.4094639,7.52822311 L14.3908925,7.49865936 L14.3296866,7.41519605 L10.1084913,2.81453208 C9.75427649,2.42609678 9.14854213,2.39266615 8.7516121,2.74003295 L8.66517015,2.82577407 Z" transform="rotate(-45 10.56 5.732)"></path>
                                    </svg>
                                </a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script type="text/javascript">
const copyToClipboard = str => {
    const el = document.getElementById('user-api-key');
    el.select();
    document.execCommand('copy');
};
document.addEventListener("DOMContentLoaded", function() {
    const apiKeyCopyButton = document.getElementById('user-api-key-copy-button');
    if (apiKeyCopyButton) {
        apiKeyCopyButton.addEventListener('click', function(e) {
            copyToClipboard();
        });
    }
});
</script>
{% endblock %}
