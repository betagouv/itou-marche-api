{% extends "dashboard/siae_edit_base.html" %}
{% load static bootstrap4 addstr %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vendor/dropzone-5.9.3/dropzone.min.css' %}" />
{% endblock %}

{% block content_siae_form %}
<form method="POST" action="" class="mb-3 mb-lg-5">
    {% csrf_token %}

    {% bootstrap_form_errors form type="all" %}
    
    <div class="row mb-3 mb-lg-5">
        <div class="col-12 col-lg-8">
            <div class="bg-white d-block rounded-lg shadow-lg p-3 p-lg-5">
                <fieldset>
                    <legend class="h4">Présenter votre structure</legend>
                    {% bootstrap_field form.description show_label=False %}
                </fieldset>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div role="alert" class="alert alert-info mt-3 mt-lg-0">
                <p>
                    <strong>Présentation</strong><br />
                    En plus des secteurs d'activités, la présentation de votre structure permet aux acheteurs
                    de faire un choix éclairé et de vous contacter.
                </p>
            </div>
        </div>
    </div>
        
    <div class="row mb-3 mb-lg-5">
        <div class="col-12 col-lg-8">
            <div class="bg-white d-block rounded-lg shadow-lg p-3 p-lg-5">
                <fieldset>
                    <legend class="h4">Détails des prestations effectués <small class="text-muted">(matériels, lieux, savoirs faire…)</small></legend>
                    {% bootstrap_formset_errors offer_formset %}
                    {% if offer_formset.errors %}
                        <div class="alert alert-danger" role="alert">{{ offer_formset.errors }}</div>
                    {% endif %}

                    {% bootstrap_formset offer_formset %}

                    <div id="offer-formset-empty-form" class="d-none">{% bootstrap_form offer_formset.empty_form %}</div>
                    <button id="offer-formset-add-more" class="btn btn-outline-primary btn-sm btn-ico float-right" type="button">
                        <span>Ajouter une prestation</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path fill="none" d="M0 0h24v24H0z"/><path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
                    </button>
                </fieldset>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div role="alert" class="alert alert-info mt-3 mt-lg-0">
                <p>
                    <strong>Prestations</strong><br />
                    En plus des secteurs d'activité, la présentation des prestations permet d'en savoir plus sur vos activités exactes.
                </p>
                <p>
                    Exemple de prestations de services :
                    Nous transformons les fruits et légumes bio ou traditionnels en produits finis (soupes, compotes, confitures).
                    Nous avons le label ECOCERT pour la transformation des matières premières biologiques.
                </p>
            </div>
        </div>
    </div>
    
    <div class="row mb-3 mb-lg-5">
        <div class="col-12 col-lg-8">
            <div class="bg-white d-block rounded-lg shadow-lg p-3 p-lg-5">
                <fieldset>
                    <legend class="h4">Références clients</legend>
                    {% bootstrap_formset_errors client_reference_formset %}
                    {% if client_reference_formset.errors %}
                        <div class="alert alert-danger" role="alert">{{ client_reference_formset.errors }}</div>
                    {% endif %}

                    {{ client_reference_formset.management_form }}

                    {% for form in client_reference_formset %}
                        <div class="fieldset">
                            {% bootstrap_field form.id %}
                            {% bootstrap_field form.name %}
                            <div class="form-group">
                                {{ form.logo_url.as_hidden }}
                                {% with "id_client_references-"|addstr:forloop.counter0|addstr:"-logo_form" as id_logo_form %}
                                    <label for="{{ id_logo_form }}" class="js-display-if-javascript-enabled">Logo</label>
                                    {% include "storage/s3_upload_form.html" with dropzone_form_id=id_logo_form %}
                                {% endwith %}
                            </div>
                            <div class="form-group">
                                <label>Logo actuel</label>
                                {% if form.logo_url.value %}
                                    <div>
                                        <img class="img-fluid" src="{{ form.logo_url.value }}" />
                                    </div>
                                {% else %}
                                    <span class="form-text text-muted">Aucun</span>
                                {% endif %}
                            </div>
                            {% bootstrap_field form.DELETE %}
                        </div>
                        <hr />
                    {% endfor %}

                    <div id="client-reference-formset-empty-form" class="d-none">
                        <div class="form-group">
                            <label for="id_client_references-__prefix__-name">Nom</label>
                            <input type="text" name="client_references-__prefix__-name" maxlength="255" class="form-control" title="" id="id_client_references-__prefix__-name">
                        </div>
                        <div class="form-group">
                            {# <label for="id_client_references-__prefix__-logo_url">Lien vers le logo</label> #}
                            <input type="hidden" name="client_references-__prefix__-logo_url" maxlength="500" class="form-control" title="" id="id_client_references-__prefix__-logo_url">
                            <label for="id_client_references-__prefix__-logo_form" class="js-display-if-javascript-enabled">Logo</label>
                            {% include "storage/s3_upload_form.html" with dropzone_form_id="id_client_references-__prefix__-logo_form" %}
                        </div>
                        <input type="hidden" name="client_references-__prefix__-id" id="id_client_references-__prefix__-id">
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" name="client_references-__prefix__-DELETE" class="form-check-input" id="id_client_references-__prefix__-DELETE">
                                <label class="form-check-label" for="id_client_references-__prefix__-DELETE">Supprimer</label>
                            </div>
                        </div>
                        <input type="hidden" name="client_references-__prefix__-siae" value="323" id="id_client_references-__prefix__-siae">
                    </div>
                    <button id="client-reference-formset-add-more" class="btn btn-outline-primary btn-sm btn-ico float-right" type="button">
                        <span>Ajouter une référence</span>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path fill="none" d="M0 0h24v24H0z"/><path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>
                    </button>
                </fieldset>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div role="alert" class="alert alert-info mt-3 mt-lg-0">
                <p>
                    <strong>Références clients</strong><br />
                    Avoir des références clients permet de donner confiance à vos futurs acheteurs et de les rassurer sur vos capacités à faire.
                </p>
                <p>
                    Vous vous demandez si vous avez le droit de mettre les logos de vos clients ?
                    Le mieux est de leur poser la question avant de les mettre sur le site.
                </p>
            </div>
        </div>
    </div>

    <div class="row mt-3 mt-lg-5 justify-content-end">
        <div class="col-12 col-lg-auto px-5 px-lg-6">
            <button type="submit" class="btn btn-primary btn-block">
                <span>Enregistrer mes modifications</span>
            </button>
        </div>
        <div class="col-12 col-lg-4"></div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/dropzone-5.9.3/dropzone.min.js' %}"></script>
<script src="{% static 'js/s3_upload.js' %}"></script>
{{ s3_form_values|json_script:"s3-form-values" }}
{{ s3_upload_config|json_script:"s3-upload-config" }}
<script>
    // loop on each dropzone
    Array.from(document.querySelectorAll(".dropzone")).forEach(function(element) {
        s3UploadInit({
            dropzoneSelector: `#${element.id}`,
            callbackLocationSelector: `#${element.id.replace('logo_form', 'logo_url')}`,
            s3FormValuesId: "s3-form-values",
            s3UploadConfigId: "s3-upload-config",
            // Not really nice
            sentryInternalUrl: "{% url 'pages:sentry_debug' %}",
            sentryCsrfToken: "{{ csrf_token }}"
        });
    })
</script>
<script>
    /**
     * Add formset items dynamically
     */
    const prefixRegex = new RegExp('__prefix__', 'g');

    // offer formset
    const totalOfferFormset = document.getElementById('id_offers-TOTAL_FORMS');
    const offerFormsetEmptyForm = document.getElementById('offer-formset-empty-form');
    const offerFormsetAddMoreButton = document.getElementById('offer-formset-add-more');

    offerFormsetAddMoreButton.addEventListener('click', function(e) {
        if (e) { e.preventDefault(); }
        // add new form
        const copyOfferFormsetEmptyForm = offerFormsetEmptyForm.cloneNode(true);
        copyOfferFormsetEmptyForm.innerHTML = copyOfferFormsetEmptyForm.innerHTML.replace(prefixRegex, totalOfferFormset.value);
        copyOfferFormsetEmptyForm.childNodes.forEach(node => {
            offerFormsetEmptyForm.parentNode.insertBefore(node, offerFormsetEmptyForm);
        });
        // update total forms count
        totalOfferFormset.setAttribute('value', parseInt(totalOfferFormset.getAttribute('value'), 10) + 1);
    });

    // client reference formset
    const totalClientReferenceFormset = document.getElementById('id_client_references-TOTAL_FORMS');
    const clientReferenceFormsetEmptyForm = document.getElementById('client-reference-formset-empty-form');
    const clientReferenceFormsetAddMoreButton = document.getElementById('client-reference-formset-add-more');

    clientReferenceFormsetAddMoreButton.addEventListener('click', function(e) {
        if (e) { e.preventDefault(); }
        // add new form
        const copyClientReferenceFormsetEmptyForm = clientReferenceFormsetEmptyForm.cloneNode(true);
        copyClientReferenceFormsetEmptyForm.innerHTML = copyClientReferenceFormsetEmptyForm.innerHTML.replace(prefixRegex, totalClientReferenceFormset.value);
        // copyClientReferenceFormsetEmptyForm.childNodes.forEach(node => {
        //     clientReferenceFormsetEmptyForm.parentNode.insertBefore(node, clientReferenceFormsetEmptyForm);
        // });
        copyClientReferenceFormsetEmptyForm.setAttribute('id', '');
        copyClientReferenceFormsetEmptyForm.setAttribute('class', '');
        clientReferenceFormsetEmptyForm.parentNode.insertBefore(copyClientReferenceFormsetEmptyForm, clientReferenceFormsetEmptyForm);
        console.log(totalClientReferenceFormset.value)
        // add dropzone
        s3UploadInit({
            dropzoneSelector: `#id_client_references-${totalClientReferenceFormset.value}-logo_form`,
            callbackLocationSelector: `#id_client_references-${totalClientReferenceFormset.value}-logo_url`,
            s3FormValuesId: "s3-form-values",
            s3UploadConfigId: "s3-upload-config",
            // Not really nice
            sentryInternalUrl: "{% url 'pages:sentry_debug' %}",
            sentryCsrfToken: "{{ csrf_token }}"
        });
        // update total forms count
        totalClientReferenceFormset.setAttribute('value', parseInt(totalClientReferenceFormset.getAttribute('value'), 10) + 1);
    });
</script>
{% endblock %}
